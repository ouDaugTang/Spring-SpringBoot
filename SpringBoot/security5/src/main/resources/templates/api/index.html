<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSRF í† í° - ìš”ì²­</title>
</head>

<body>
    <h1>CSRF í† í° - ìš”ì²­</h1>

    <!-- 
        ğŸ CSRF í† í° í—¤ë”
        FORM ìš”ì²­ : _csrf           (íŒŒë¼ë¯¸í„°ì— ë„£ì€ê±¸ ì‹œíë¦¬í‹°ê°€ ì¸ì‹)
        AJAX ìš”ì²­ : X-CSRF-TOKEN    (í—¤ë”ì— ì§ì ‘ ë„£ê¸°)
     -->

    <h3>CSRF í† í° - FORM ìš”ì²­</h3>
    <form action="/api/form" method="post">
        <!-- ğŸ’ CSRF TOKEN -->
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <input type="text" name="name" id="name" placeholder="ì´ë¦„">
        <button type="submit">FORM ìš”ì²­</button>

    </form>

    <h3>CSRF í† í° - AJAX ìš”ì²­</h3>
    <button type="button" onclick="ajax()">AJAX ìš”ì²­</button>
    <button type="button" onclick="ajaxJQuery()">AJAX ìš”ì²­ (JQuery)</button>


    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script>
        //â­ CRSF TOKEN
        const csrfToken = "[[${_csrf.token}]]"

        function ajax() {
            let request = new XMLHttpRequest()
            let data = {
                "name": document.getElementById("name").value
            }
            request.open("POST", "/api/ajax")
            request.setRequestHeader("Content-Type", "application/json")
            request.setRequestHeader("X-CSRF-TOKEN", csrfToken) // â­
            request.send(JSON.stringify(data))
            request.onreadystatechange = function () {
                if (request.readyState == request.DONE && request.status == 200) {
                    const response = request.responseText
                    alert(response)
                }
            }
        }

        function ajaxJQuery() {
            let data = {
                "name": document.getElementById("name").value
            }

            $.ajax({
                type: "POST",                  // ìš”ì²­ ë©”ì†Œë“œ
                url: "/api/ajax",             // ìš”ì²­ URL 
                data: JSON.stringify(data),    // ë°ì´í„°
                contentType: "application/json",      // ìš”ì²­ ë°ì´í„° íƒ€ì…
                dataType: "html",                  // ìš”ì²­ ë°ì´í„° íƒ€ì…
                // ìš”ì²­ ì „ ì„¤ì •
                beforeSend: function (xhr) {
                    /* CSRF TOKEN ì„¤ì •*/

                    xhr.setRequestHeader("X-CSRF-TOKEN", csrfToken)
                },
                // ìš”ì²­ ì„±ê³µ
                success: function (response) {
                    alert(response)
                },
                //ìš”ì²­ ì‹¤íŒ¨
                error: function (xhr, status, error) {
                    console.log("ìš”ì²­ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.")
                }
            })
        }
    </script>
</body>

</html>